<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

        <title>Babylon.js sample code</title>

        <!-- Babylon.js -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.6.2/dat.gui.min.js"></script>
        <script src="https://preview.babylonjs.com/ammo.js"></script>
        <script src="https://preview.babylonjs.com/cannon.js"></script>
        <script src="https://preview.babylonjs.com/Oimo.js"></script>
        <script src="https://preview.babylonjs.com/earcut.min.js"></script>
        <script src="https://preview.babylonjs.com/babylon.js"></script>
        <script src="https://preview.babylonjs.com/materialsLibrary/babylonjs.materials.min.js"></script>
        <script src="https://preview.babylonjs.com/proceduralTexturesLibrary/babylonjs.proceduralTextures.min.js"></script>
        <script src="https://preview.babylonjs.com/postProcessesLibrary/babylonjs.postProcess.min.js"></script>
        <script src="https://preview.babylonjs.com/loaders/babylonjs.loaders.js"></script>
        <script src="https://preview.babylonjs.com/serializers/babylonjs.serializers.min.js"></script>
        <script src="https://preview.babylonjs.com/gui/babylon.gui.min.js"></script>
        <script src="https://preview.babylonjs.com/inspector/babylon.inspector.bundle.js"></script>

        <style>
            html, body {
                overflow: hidden;
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
            }

            #renderCanvas {
                width: 100%;
                height: 100%;
                touch-action: none;
            }
        </style>
    </head>
<body>
    <div id='startCover' style="width: 100%; height: 100%; background-color: black;">
        <div id='vipermanName' style="width: 90%; height: 17%; margin-left: 5%; background-image: url('img/sandviperName1.png'); background-size: cover;"></div>
        <div id='vipermanLogo' style="width: 30%; height: 70%; margin-left: 32%; background-image: url('img/sandviperLogo.png'); background-size: cover;"></div>
        <h1 id='start' style="font: 900 50px arial; text-align: center; color: white"; >Start Game</h1>
    </div>
    <canvas id="renderCanvas"></canvas>
    
    <script>
       
        var start = document.getElementById('start');
        var startCover = document.getElementById('startCover');
        var gameOver = document.getElementById('gameOver');
        var score = document.getElementById('score');
        var canvas = document.getElementById("renderCanvas");

    //BABYLON START

        var engine = null;
        var scene = null;
        var sceneToRender = null;
        var createDefaultEngine = function() { return new BABYLON.Engine(canvas, true, { preserveDrawingBuffer: true, stencil: true,  disableWebGL2Support: false}); };

    //START GAME
    // start.onclick = () => {
        startCover.style.display = 'none';

        var createScene = function () {
        
            var scene = new BABYLON.Scene(engine);
            
            //MUSIC IN THE GAME
            
            var gameMusic = new BABYLON.Sound("gameMusic", "sounds/TRON Legacy (End Titles).mp3", scene, null, {
                loop: true,
                autoplay: true
            });

            //LIGHT
            var light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0, 1, -1), scene);
            light.intensity = 0.7;
            var light2 = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0, 1, 1), scene);
            light2.intensity = 0.7;
            

            // CAMERA MAIN

            //movement camera
            // var camera = new BABYLON.UniversalCamera("MyCamera", new BABYLON.Vector3(0, 1, 0), scene);
            // camera.minZ = 0.0001;
            // camera.attachControl(canvas, true);
            // camera.speed = 0.005;
            // camera.angularSpeed = 0.02;
            // camera.angle = Math.PI/2;
            // camera.direction = new BABYLON.Vector3(Math.cos(camera.angle), 0, Math.sin(camera.angle));
            
            // //view camera
            // var viewCamera = new BABYLON.UniversalCamera("viewCamera", new BABYLON.Vector3(0, 2, -5), scene);
            // viewCamera.parent = camera;
            // viewCamera.setTarget(new BABYLON.Vector3(0, -0.0001, 1));
            
            // //Activate both cameras
            // scene.activeCameras.push(camera);
            // scene.activeCameras.push(viewCamera);//shoud be second

            //test
            // var camera = new BABYLON.UniversalCamera("UniversalCamera", new BABYLON.Vector3(0, 2, -5), scene);
            // camera.attachControl(canvas, true);
            //rotate camera
            var camera = new BABYLON.ArcRotateCamera("Camera", 0, 0, 0, new BABYLON.Vector3(0, 0, 0), scene);
            camera.setPosition(new BABYLON.Vector3(0, 3, -5));
            

            //MOVMENT OF THE CAMERA
            //movment of viper and view camrera
            // scene.beforeRender = function() {
                // camera.rotation.y = 0;
                // camera.rotation.x = 0;
                // camera.position.z += 0.2;
            // };
            
            //rotate around viper
            // scene.onBeforeCameraRenderObservable.add(()=>{
            //     scene.activeCamera.alpha += .002;
            // })

            //CREATE A BOX  BACKGROUND

            // HDR texture of background
            var hdrBcgRefTexture = new BABYLON.HDRCubeTexture("textures/shangai.hdr", scene, 128);

            // Skybox
            var hdrSkybox = BABYLON.Mesh.CreateBox("hdrSkyBox", 5000.0, scene);
            var hdrSkyboxMaterial = new BABYLON.PBRMaterial("skyBox", scene);
            hdrSkyboxMaterial.backFaceCulling = false;
            hdrSkyboxMaterial.reflectionTexture = hdrBcgRefTexture.clone();
            hdrSkyboxMaterial.reflectionTexture.coordinatesMode = BABYLON.Texture.SKYBOX_MODE;
            hdrSkyboxMaterial.microSurface = 1.0;
            hdrSkyboxMaterial.cameraExposure = 0.66;
            hdrSkyboxMaterial.cameraContrast = 1.66;
            hdrSkyboxMaterial.disableLighting = true;
            hdrSkybox.material = hdrSkyboxMaterial;
            hdrSkybox.infiniteDistance = true;
            
            //GIVE GLOW TO GLOWING OBJ

            var glow = new BABYLON.GlowLayer("glow", scene);
            glow.intensity = 0.8;


            //IMPORT VIPERMAN MESH
            //viperman
            BABYLON.SceneLoader.ImportMeshAsync("", "", "meshes/viperman.glb").then((result) => { 
                var viperman =  result.meshes[0];
                // viperman.parent = camera;
                // viperman.position.y = -1;
                scene.beforeRender = function() {
                    // camera.rotation.y = 0;
                    // camera.rotation.x = 0;
                    viperman.position.z += 0.2;
                    if (viperman.position.z % 500  == 0){
                        viperman.position.y = 10;
                    }
                };
                
                //fake meshes
                var fakeMesh = new BABYLON.MeshBuilder.CreateBox("fakeMesh", {width: 0.2, height: 0.2, depth: 0.2}, scene);
                fakeMesh.position = new BABYLON.Vector3(0,1.8,0)
                fakeMesh.parent = viperman;
                fakeMesh.isVisible = false;
                camera.target = fakeMesh;

                var fakeMeshEllipse = new BABYLON.MeshBuilder.CreateBox("fakeMeshEllipse", {width: 0.2, height: 0.2, depth: 0.2}, scene);
                fakeMeshEllipse.position = new BABYLON.Vector3(0,1,0)
                fakeMeshEllipse.parent = viperman;
                fakeMeshEllipse.isVisible = false;
                // camera.target = fakeMeshEllipse;

                //Create Visible Ellipsoid around mesh
                var a = 0.5;
                var b = 1;
                var points = [];
                for(var theta = -Math.PI/2; theta < Math.PI/2; theta += Math.PI/36) {
                    points.push(new BABYLON.Vector3(0, b * Math.sin(theta), a * Math.cos(theta)));
                }
                var ellipse = [];
                ellipse[0] = BABYLON.MeshBuilder.CreateLines("e", {points:points}, scene);
                ellipse[0].isVisible = false;
                ellipse[0].parent = fakeMeshEllipse;
                ellipse[0].rotation.y = 5 * Math.PI/ 16;
                for(var i = 1; i < 23; i++) {
                    ellipse[i] = ellipse[0].clone("el" + i);
                    ellipse[i].parent = fakeMeshEllipse;
                    ellipse[i].rotation.y = 5 * Math.PI/ 16 + i * Math.PI/16;
                    ellipse[i].isVisible = false;
                    ellipse[i].checkCollisions = true;
                }
                
                //SANDVIPER LOGO FOR COINS
                BABYLON.SceneLoader.ImportMeshAsync("", "", "meshes/logo.glb").then((result) => { 
                    var coinLogo = result.meshes[0];
                    coinLogo.position = new BABYLON.Vector3(0,-5,15)
                    var coinLogoMat = new BABYLON.StandardMaterial("coinLogoMat", scene);
                    coinLogoMat.emissiveColor = new BABYLON.Color3.FromHexString('#ffffff');
                    scene.getMeshByName("Plane").material = coinLogoMat;
                    coinLogo.rotationQuaternion = null;
                    coinLogo.checkCollisions = true;
                    coins = [];
                    function createCoinLane(coinLanePositionX, coinLanePositionZ){
                        for (var i = 1; i < 11; i++) {
                            var newCoin = coinLogo.clone("coin" + i);
                            coins.push(newCoin);
                            newCoin.position = new BABYLON.Vector3(coinLanePositionX, 0.5, (coinLanePositionZ + i * 3));
                        }
                    }
                    createCoinLane(3, 30);
                    createCoinLane(0.01, 100);
                    console.log(coins.length)
                    //coin colider
                    for (let j = 0; j < ellipse.length; j++) {
                        ellipse[j].actionManager = new BABYLON.ActionManager(scene);
                        for (let i = 0; i < coins.length; i++) {
                            coins[i].checkCollisions = true;
                            coins[i].actionManager = new BABYLON.ActionManager(scene);
                                let action = new BABYLON.ExecuteCodeAction(
                                    {
                                        trigger: BABYLON.ActionManager.OnIntersectionEnterTrigger, 
                                        parameter: { 
                                            mesh: coins[i]
                                        }
                                    },
                                    (evt) => {
                                        // if (coins[i].isVisible) { 
                                        // //     coinNumber += 1;
                                        // //     coinSound.play();
                                        // //     console.log('Coins: ' + coinNumber)
                                        // //     coinBlock.text = "Coins: " + coinNumber;
                                            coins[i].isVisible = false;
                                            coins[i].setEnabled(false);
                                        // }
                                    }
                                );  
                                ellipse[j].actionManager.registerAction(action);
                        }
                    }
                })
                
                //VIPER MESH IMPORT ANIMATION
                //run animation
                var runAnim = scene.animationGroups.find(a => a.name === 'run');
                var runParam = { name: "Run", anim: runAnim, weight: 0 };
                runAnim.setWeightForAllAnimatables(1);
                runAnim.start(true, 1, 0);
                //jump animation
                var jumpAnim = scene.animationGroups.find(a => a.name === 'jump');
                var jumpParam = { name: "Jump", anim: jumpAnim, weight: 0 };
                jumpAnim.setWeightForAllAnimatables(0);
                //hit animation
                var hitAnim = scene.animationGroups.find(a => a.name === 'hit_in');
                var hitParam = { name: "Hit", anim: hitAnim, weight: 0 };
                hitAnim.setWeightForAllAnimatables(0);
                //finsh animation
                var finishAnim = scene.animationGroups.find(a => a.name === 'finish');
                var finishParam = { name: "Finish", anim: jumpAnim, weight: 0 };
                finishAnim.play(true);
                finishAnim.setWeightForAllAnimatables(0);
                //game over animation
                var gameOverAnim = scene.animationGroups.find(a => a.name === 'game_over');
                var gameOverParam = { name: "gameOver", anim: gameOverAnim, weight: 0 };
                gameOverAnim.setWeightForAllAnimatables(0);
                //start animation
                var startAnim = scene.animationGroups.find(a => a.name === 'start');
                var startParam = { name: "Start", anim: startAnim, weight: 0 };
                startAnim.setWeightForAllAnimatables(0);
                //slide animation
                var slideAnim = scene.animationGroups.find(a => a.name === 'slide');
                var slideParam = { name: "Slide", anim: slideAnim, weight: 0 };
                slideAnim.setWeightForAllAnimatables(0);
                
                //VIPER MESH BABYLON.JS CREATED ANIMATION
                //move left and right
                function moveViperAnim(mesh, pos, direction){
                    const anim= new BABYLON.Animation("moveLeftAnim", "position.x", 60, BABYLON.Animation.ANIMATIONTYPE_FLOAT, BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE);
                    anim.setKeys([
                        { frame: 0, value: pos },
                        { frame: 15, value: direction },
                    ]);
                    mesh.animations = [];
                    mesh.animations.push(anim);
                    return scene.beginAnimation(mesh, 0, 15, false);
                }
                //jump animation
                function aniPosY(mesh){
                    const anim= new BABYLON.Animation("animPosY", "position.y", 30, BABYLON.Animation.ANIMATIONTYPE_FLOAT, BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE);
                    anim.setKeys([
                        { frame: 0, value: 0 },
                        { frame: 10, value: 3 },
                        { frame: 18, value: 3.5 },
                        { frame: 20, value: 3.5 },
                        { frame: 30, value: 0 },
                    ]);
                    mesh.animations = [];
                    mesh.animations.push(anim);
                    return scene.beginAnimation(mesh, 0, 30, false);
                }
                
                //EVENT LISTENERS
                document.onkeydown = checkKey;
                function checkKey(event) {
                    if (event.keyCode == 38) {
                     console.log('aaaaaaaaa')
                    }
                    //jump on ins0
                    if (event.keyCode == 96 && viperman.position.y == 0) {
                        //jumpSound.play();
                        console.log('jump')
                        aniPosY(viperman)
                        jumpAnim.start(false, 1, 0);
                        runAnim.setWeightForAllAnimatables(0);
                        setTimeout(function(){ 
                            runAnim.setWeightForAllAnimatables(1);
                        }, 950)
                    }
                    //viper move left
                    if (event.keyCode == 37) {
                    if (viperman.position.x == 0 || viperman.position.x == 3) {
                        moveViperAnim(viperman, viperman.position.x, viperman.position.x-3)
                            for (let i = 0; i < result.meshes.length; i++) {
                                result.meshes[i].addRotation(0,-0.3,0)
                            }
                            setTimeout(function(){ 
                                for (let i = 0; i < result.meshes.length; i++) {
                                    result.meshes[i].addRotation(0,0.3,0)
                                }
                            }, 250)
                        }
                    }
                    //viper move right
                    if (event.keyCode == 39) {
                        if (viperman.position.x == 0 || viperman.position.x == -3) {
                            moveViperAnim(viperman, viperman.position.x, viperman.position.x+3)
                            for (let i = 0; i < result.meshes.length; i++) {
                                result.meshes[i].addRotation(0,0.3,0)
                            }
                            setTimeout(function(){ 
                            for (let i = 0; i < result.meshes.length; i++) {
                                result.meshes[i].addRotation(0,-0.3,0)
                            }
                            }, 250)
                        }
                    }
                    //viper slide down
                    if (event.keyCode == 40 && fakeMeshEllipse.position.y == 1) {
                        slideAnim.start(false, 1, 0);
                        runAnim.setWeightForAllAnimatables(0);
                        fakeMeshEllipse.position.y = 0;
                        setTimeout(function(){ 
                            if (event.keyCode == 40){runAnim.setWeightForAllAnimatables(0);}
                            fakeMeshEllipse.position.y = 1;
                            runAnim.setWeightForAllAnimatables(1);
                        }, 1580)
                    }
                }
                document.onkeyup = checkKeyUp;
                function checkKeyUp(event) {
                    if (event.keyCode == 38) {
                        console.log('bbbbbb')
                    }
                }
            
            })
            ;
           
            //CREATE BRIDGE-PATH FOR VIPER TO RUN
            function createRunningTrack(){
                
                //main platform for running
                var bridge = BABYLON.MeshBuilder.CreateGround("ground", {width: 9, height:1000}, scene);
                var bridgeMat = new BABYLON.StandardMaterial("bridgeMat", scene);
                // bridgeMat.emissiveColor = new BABYLON.Color3.FromHexString('#000000');
                bridgeMat.diffuseTexture = new BABYLON.Texture("img/podloga2.jpg", scene);
                bridgeMat.diffuseTexture.uScale = 1;
                bridgeMat.diffuseTexture.vScale = 200;
                bridge.material = bridgeMat;
                bridge.position.z = 490;

                //create glass walls
                var glassWall = new BABYLON.MeshBuilder.CreateBox("glassWall", {width: 0.05, height: 3, depth: 1000}, scene);
                glassWall.position = new BABYLON.Vector3(-5,1,490)
                var glassWallMat = new BABYLON.PBRMaterial("glassWallMat", scene);
                glassWallMat.reflectionTexture = hdrBcgRefTexture;
                glassWallMat.refractionTexture = hdrBcgRefTexture;
                glassWallMat.linkRefractionWithTransparency = true;
                glassWallMat.indexOfRefraction = 0.52;
                glassWallMat.alpha = 0;
                glassWallMat.directIntensity = 0.0;
                glassWallMat.environmentIntensity = 0.7;
                glassWallMat.cameraExposure = 0.66;
                glassWallMat.cameraContrast = 1.66;
                glassWallMat.reflectivityColor = new BABYLON.Color3(0.1, 0.1, 0.1);
                glassWallMat.albedoColor = new BABYLON.Color3(0.1, 0.1, 0.1);
                glassWall.material = glassWallMat;
                //other glass walls
                var glassWall2 = glassWall.clone("glassWall2");
                glassWall2.position.x = 5;

                var box = new BABYLON.MeshBuilder.CreateBox("box", {width: 0.2, height: 0.5, depth: 2}, scene);
            box.position = new BABYLON.Vector3(-5,2,30);
            var boxMat = new BABYLON.StandardMaterial("boxMat", scene);
            boxMat.diffuseColor = new BABYLON.Color3.FromHexString('#ff5722')
            boxMat.emissiveColor = new BABYLON.Color3.FromHexString('#ff5722')
             // boxMat.alpha = 0.5;
             box.material = boxMat;

             var box2 = new BABYLON.MeshBuilder.CreateBox("box", {width: 0.3, height: 0.4, depth: 1.8}, scene);
            box2.position = new BABYLON.Vector3(-5,2,30);
            // box2.addRotation(0,0.8,0)
             box2.material = glassWallMat;

             const plane = BABYLON.MeshBuilder.CreatePlane("plane", {height:1, width: 2});
             plane.position = new BABYLON.Vector3(0,2,30);
            // plane.addRotation(0,1.6,0)
            var planemat = new BABYLON.StandardMaterial("planemat", scene);
    var t = new BABYLON.Texture("img/vipermanDemo.png", scene);
    t.hasAlpha = true;
    planemat.diffuseTexture = t;
    planemat.emissiveColor = new BABYLON.Color3.FromHexString('#ff5722')
    planemat.useAlphaFromDiffuseTexture = true;
    plane.material = planemat;
            
                //side walks
                var sideWalk = new BABYLON.MeshBuilder.CreateBox("sideWalk", {width: 1, height: 0.4, depth: 1000}, scene);
                var sideWalkMat = new BABYLON.StandardMaterial("sideWalkMat", scene);
                sideWalkMat.diffuseColor = new BABYLON.Color3.FromHexString('#cd00cd')
                sideWalkMat.emissiveColor = new BABYLON.Color3.FromHexString('#cd00cd');
                sideWalk.material = sideWalkMat;
                sideWalk.position = new BABYLON.Vector3(-5,0,490)
                //other sidewalk
                var sideWalk2 = sideWalk.clone("sideWalk2");
                sideWalk2.position.x = 5;
                //side walks glass part
                var sideWalkGlassPart = new BABYLON.MeshBuilder.CreateBox("sideWalkGlassPart", {width: 0.1, height: 0.1, depth: 1000}, scene);
                sideWalkGlassPart.material = glassWallMat;
                sideWalkGlassPart.position = new BABYLON.Vector3(-4.5,0.2,490)
                //other sidewalk glass part
                var sideWalkGlassPart2 = sideWalkGlassPart.clone("sideWalkGlassPart2");
                sideWalkGlassPart2.position.x = 4.5;
                
                //running tracks
                var runningTrack = new BABYLON.MeshBuilder.CreateBox("runningTrack", {width: 0.2, height: 0.1, depth: 1000}, scene);
                var runningTrackMat = new BABYLON.StandardMaterial("runningTrackMat", scene);
                runningTrackMat.emissiveColor = new BABYLON.Color3.FromHexString('#00cdcd');
                runningTrack.material = runningTrackMat;
                runningTrack.position = new BABYLON.Vector3(-1.5,0,490)
                //right running track
                var runningTrackRight = runningTrack.clone("runningTrackRight");
                runningTrackRight.position.x = 1.5;
                //running tracks glass part
                var runningGlassPart = sideWalkGlassPart.clone("runningGlassPart");
                runningGlassPart.position = new BABYLON.Vector3(-1.5,0.05,490)
                //running tracks glass part right
                var runningGlassPartRight = sideWalkGlassPart.clone("runningGlassPartRight");
                runningGlassPartRight.position = new BABYLON.Vector3(1.5,0.05,490)
                
            }








            createRunningTrack()
            console.log(scene.meshes.length)
            // setInterval(function(){ 
            //     console.log(engine.getFps())
            //     console.log(camera.position)
            // }, 1000)
            //SCORE AND LIFE DISPLAY

            // var advancedTexture = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("UI");

            // var panel = new BABYLON.GUI.StackPanel();
            // panel.width = 1200 + 'px';
            // panel.height = 500 + 'px';
            // panel.isVertical = true;
            // panel.left = 0 + "px";
            // panel.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_CENTER;
            // panel.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP;
            // advancedTexture.addControl(panel);

            // var viperDemo = new BABYLON.GUI.Image("", "img/vipermanDemo.png");
            // viperDemo.width = "1000px";
            // viperDemo.height = "357px";
            // panel.addControl(viperDemo);

            // var panel = new BABYLON.GUI.StackPanel();
            // panel.width = 800 + 'px';
            // panel.height = 200 + 'px';
            // panel.isVertical = true;
            // panel.left = -100 + "px";
            // panel.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT;
            // panel.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP;
            // advancedTexture.addControl(panel);    

            // var coinBlock = new BABYLON.GUI.TextBlock();
            // coinBlock.text = "Coins: 0";
            // coinBlock.height = 100 + "px";
            // coinBlock.color = "#fff";
            // coinBlock.fontSize = 50 + "px";

            // panel.addControl(coinBlock);

            // var livesBlock = new BABYLON.GUI.TextBlock();
            // livesBlock.text = "Lives: 3";
            // livesBlock.height = 100 + "px";
            // livesBlock.color = "#fff";
            // livesBlock.fontSize = 50 + "px";

            // panel.addControl(livesBlock);

            return scene;
            //END OF SCENE
        
        }


        window.initFunction = async function() {               
            var asyncEngineCreation = async function() {
                try {
                    return createDefaultEngine();
                    } catch(e) {
                        console.log("the available createEngine function failed. Creating the default engine instead");
                        return createDefaultEngine();
                    }
                }

        window.engine = await asyncEngineCreation();
        if (!engine) throw 'engine should not be null.';
        window.scene = createScene();};
        
        initFunction().then(() => {sceneToRender = scene        
            engine.runRenderLoop(function () {
                if (sceneToRender && sceneToRender.activeCamera) {
                    sceneToRender.render();
                }
            });
        });

        // Resize
        window.addEventListener("resize", function () {
            engine.resize();
        });
    // }//END OF GAME


    </script>
</body>
</html>